<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Azure OpenAI TTS Audio Soundboard</title>
    <link rel="stylesheet" th:href="@{/styles.css}">
</head>
<body>
    <div class="container">
        <header>
            <h1>Azure OpenAI TTS Audio Soundboard</h1>
            <p>Transform your text into natural-sounding speech using Azure OpenAI</p>
        </header>

        <!-- Status Messages -->
        <div th:if="${success}" class="alert alert-success" role="alert" aria-live="polite">
            <span th:text="${success}"></span>
        </div>
        
        <div th:if="${warning}" class="alert alert-warning" role="alert" aria-live="polite">
            <span th:text="${warning}"></span>
        </div>
        
        <div th:if="${error}" class="alert alert-error" role="alert" aria-live="polite">
            <span th:text="${error}"></span>
        </div>

        <!-- TTS Form -->
        <section class="tts-form">
            <!-- Voice Selection -->
            <div class="voice-selection">
                <h2>Choose Voice</h2>
                <div class="voice-label-display" id="voiceDisplay">Voice: Select a voice</div>
                <div class="voice-grid-new">
                    <div th:each="voice : ${voices}" class="voice-button-new" th:data-voice="${voice}">
                        <span th:text="${#strings.capitalize(voice)}"></span>
                    </div>
                    <div class="voice-button-new random-voice" data-voice="random">
                        <span>Random</span>
                    </div>
                </div>
            </div>

            <!-- Vibe Selection -->
            <div class="vibe-selection">
                <h2>Choose Vibe</h2>
                <div class="vibe-controls">
                    <div class="vibe-grid">
                        <div th:each="vibe : ${vibes}" class="vibe-button" th:data-vibe="${vibe.name}">
                            <span th:text="${vibe.name}"></span>
                        </div>
                    </div>
                    <button type="button" class="btn btn-secondary shuffle-vibes">üé≤ Shuffle Vibes</button>
                </div>
                
                <div class="vibe-details">
                    <div class="vibe-description">
                        <h3>Description</h3>
                        <div id="vibeDescription" class="description-content">Select a vibe to see the description</div>
                    </div>
                    <div class="vibe-script">
                        <h3>Sample Script</h3>
                        <div id="vibeScript" class="script-content">Select a vibe to see the sample script</div>
                    </div>
                </div>
            </div>

            <!-- Text Input and Controls -->
            <form method="post" action="/tts" id="ttsForm">
                <input type="hidden" name="voice" id="selectedVoice" value="">
                <input type="hidden" name="style" id="selectedStyle" value="">
                
                <div class="form-group">
                    <label for="text">Input Text:</label>
                    <textarea id="text" name="text" rows="6" placeholder="Enter your own text or use a vibe script..." 
                              maxlength="4000" required th:text="${lastText}"></textarea>
                    <small class="char-counter">Maximum 4000 characters</small>
                </div>

                <div class="form-group">
                    <label for="format">Audio Format:</label>
                    <select id="format" name="format">
                        <option value="mp3" th:selected="${lastFormat == 'mp3' or lastFormat == null}">MP3 (Recommended)</option>
                        <option value="wav" th:selected="${lastFormat == 'wav'}">WAV (High Quality)</option>
                        <option value="opus" th:selected="${lastFormat == 'opus'}">Opus (Small Size)</option>
                    </select>
                </div>

                <div class="form-actions">
                    <button type="submit" class="btn btn-primary" id="generateBtn">
                        üéµ Generate Voice
                    </button>
                    <button type="button" class="btn btn-secondary" id="useVibeScriptBtn">
                        üìù Use Vibe Script
                    </button>
                </div>
            </form>
        </section>

        <!-- Generated Content -->
        <div th:if="${lastText}" class="results-section">
            <section class="text-display">
                <h2>Your Text</h2>
                <div class="text-content" th:text="${lastText}"></div>
                <div class="text-metadata">
                    <span><strong>Voice:</strong> <span th:text="${#strings.capitalize(lastVoice)}"></span></span>
                    <span th:if="${lastStyle}"><strong>Style:</strong> <span th:text="${lastStyle}"></span></span>
                    <span th:if="${lastFormat}"><strong>Format:</strong> <span th:text="${#strings.toUpperCase(lastFormat)}"></span></span>
                </div>
            </section>

            <section th:if="${audioId}" class="audio-section">
                <h2>Generated Audio</h2>
                <div class="audio-player">
                    <audio controls autoplay preload="auto">
                        <source th:src="@{'/audio/' + ${audioId} + '?format=' + ${lastFormat != null ? lastFormat : 'mp3'}}" 
                                th:type="${lastFormat == 'wav' ? 'audio/wav' : (lastFormat == 'opus' ? 'audio/opus' : 'audio/mpeg')}">
                        Your browser does not support the audio element.
                    </audio>
                </div>
                <div class="audio-actions">
                    <a th:href="@{'/audio/' + ${audioId} + '?download=true&format=' + ${lastFormat != null ? lastFormat : 'mp3'}}" 
                       class="btn btn-secondary" download>
                        üì• Download <span th:text="${#strings.toUpperCase(lastFormat != null ? lastFormat : 'mp3')}">MP3</span>
                    </a>
                    <span class="audio-info" th:text="'File size: ' + ${audioSize}"></span>
                </div>
            </section>
        </div>

        <!-- Loading indicator -->
        <div id="loading" class="loading" style="display: none;" aria-live="polite">
            <div class="spinner"></div>
            <span>Generating voice...</span>
        </div>
    </div>

    <script>
        // Global variables
        let selectedVoice = '';
        let selectedVibe = null;
        let allVibes = /*[[${allVibes}]]*/ [];

        // Initialize the app
        document.addEventListener('DOMContentLoaded', function() {
            initializeVoiceButtons();
            initializeVibeButtons();
            initializeForm();
            setupCharacterCounter();
        });

        // Voice selection functionality
        function initializeVoiceButtons() {
            const voiceButtons = document.querySelectorAll('.voice-button-new');
            const voiceDisplay = document.getElementById('voiceDisplay');
            
            voiceButtons.forEach(button => {
                button.addEventListener('click', function() {
                    // Remove active class from all buttons
                    voiceButtons.forEach(btn => btn.classList.remove('active'));
                    
                    // Add active class to clicked button
                    this.classList.add('active');
                    
                    const voice = this.dataset.voice;
                    if (voice === 'random') {
                        // Select random voice
                        const voices = /*[[${voices}]]*/ [];
                        const randomVoice = voices[Math.floor(Math.random() * voices.length)];
                        selectedVoice = randomVoice;
                        voiceDisplay.textContent = `Voice: ${randomVoice.charAt(0).toUpperCase() + randomVoice.slice(1)} (Random)`;
                    } else {
                        selectedVoice = voice;
                        voiceDisplay.textContent = `Voice: ${voice.charAt(0).toUpperCase() + voice.slice(1)}`;
                    }
                    
                    document.getElementById('selectedVoice').value = selectedVoice;
                });
            });
        }

        // Vibe selection functionality
        function initializeVibeButtons() {
            updateVibeButtons();
            
            document.querySelector('.shuffle-vibes').addEventListener('click', function() {
                shuffleVibes();
            });
            
            document.getElementById('useVibeScriptBtn').addEventListener('click', function() {
                if (selectedVibe && selectedVibe.script) {
                    document.getElementById('text').value = selectedVibe.script;
                    updateCounter();
                }
            });
        }

        function updateVibeButtons() {
            const vibeGrid = document.querySelector('.vibe-grid');
            const vibes = /*[[${vibes}]]*/ [];
            
            vibeGrid.innerHTML = '';
            vibes.forEach(vibe => {
                const button = document.createElement('div');
                button.className = 'vibe-button';
                button.dataset.vibe = vibe.name;
                button.innerHTML = `<span>${vibe.name}</span>`;
                
                button.addEventListener('click', function() {
                    selectVibe(vibe);
                });
                
                vibeGrid.appendChild(button);
            });
        }

        function selectVibe(vibe) {
            // Remove active class from all vibe buttons
            document.querySelectorAll('.vibe-button').forEach(btn => btn.classList.remove('active'));
            
            // Add active class to selected button
            event.target.closest('.vibe-button').classList.add('active');
            
            selectedVibe = vibe;
            
            // Update description and script
            document.getElementById('vibeDescription').innerHTML = vibe.description.replace(/\\n/g, '<br>');
            document.getElementById('vibeScript').textContent = vibe.script;
            document.getElementById('selectedStyle').value = vibe.description;
        }

        function shuffleVibes() {
            fetch('/api/vibes?count=6')
                .then(response => response.json())
                .then(vibes => {
                    const vibeGrid = document.querySelector('.vibe-grid');
                    vibeGrid.innerHTML = '';
                    
                    vibes.forEach(vibe => {
                        const button = document.createElement('div');
                        button.className = 'vibe-button';
                        button.dataset.vibe = vibe.name;
                        button.innerHTML = `<span>${vibe.name}</span>`;
                        
                        button.addEventListener('click', function() {
                            selectVibe(vibe);
                        });
                        
                        vibeGrid.appendChild(button);
                    });
                })
                .catch(error => {
                    console.error('Error shuffling vibes:', error);
                });
        }

        // Form handling
        function initializeForm() {
            document.getElementById('ttsForm').addEventListener('submit', function(e) {
                if (!selectedVoice) {
                    e.preventDefault();
                    alert('Please select a voice first!');
                    return;
                }
                
                document.getElementById('loading').style.display = 'flex';
            });
        }

        // Character counter
        function setupCharacterCounter() {
            const textarea = document.getElementById('text');
            const counter = document.querySelector('.char-counter');
            
            function updateCounter() {
                const current = textarea.value.length;
                const max = 4000;
                counter.textContent = `${current}/${max} characters`;
                
                if (current > max * 0.9) {
                    counter.style.color = '#e74c3c';
                } else {
                    counter.style.color = '#666';
                }
            }
            
            textarea.addEventListener('input', updateCounter);
            updateCounter();
            
            // Make updateCounter available globally
            window.updateCounter = updateCounter;
        }

        // Audio player enhancements (keeping existing functionality)
        const audioElement = document.querySelector('audio');
        if (audioElement) {
            audioElement.addEventListener('loadstart', function() {
                console.log('Audio loading started');
            });
            
            audioElement.addEventListener('canplay', function() {
                console.log('Audio can start playing');
                audioElement.play().catch(function(error) {
                    console.log('Auto-play was prevented:', error);
                    const audioSection = document.querySelector('.audio-section');
                    if (audioSection) {
                        const notice = document.createElement('div');
                        notice.className = 'alert alert-warning';
                        notice.textContent = 'Click the play button to hear your generated audio (autoplay was blocked by browser)';
                        audioSection.insertBefore(notice, audioSection.firstChild);
                    }
                });
            });
            
            audioElement.addEventListener('error', function(e) {
                console.error('Audio error:', e);
                alert('Error loading audio. Please try generating again.');
            });
            
            audioElement.load();
            
            setTimeout(function() {
                audioElement.play().catch(function(error) {
                    console.log('Immediate auto-play was prevented:', error);
                });
            }, 100);
        }

        // Auto-hide alerts after 5 seconds
        document.querySelectorAll('.alert').forEach(alert => {
            setTimeout(() => {
                alert.style.opacity = '0';
                setTimeout(() => alert.remove(), 300);
            }, 5000);
        });
    </script>
</body>
</html>
